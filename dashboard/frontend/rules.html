<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Rules - WAF Dashboard</title>
    <link rel="stylesheet" href="assets/css/rules.css">    
</head>
<body>
     <div class="container">
        <!-- ========== SIDEBAR ========== -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>
                    <span>üõ°Ô∏è</span>
                    <span>Automated WAF</span>
                </h2>

            </div>
            <nav>
                <a href="index.html" class="active">
                    <span class="icon">üìä</span>
                    <span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
                </a>
                <a href="logs.html">
                    <span class="icon">üìù</span>
                    <span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ</span>
                </a>
                <a href="rules.html">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏é</span>
                </a>
                <!-- <a href="alerts.html">
                    <span class="icon">üîî</span>
                    <span>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                </a>
                <a href="#" class="separator">
                    <span class="icon">ü§ñ</span>
                    <span>‡∏Å‡∏é‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏à‡∏≤‡∏Å AI/ML</span>
                </a>
                <a href="#">
                    <span class="icon">üîß</span>
                    <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                </a>
                <a href="#">
                    <span class="icon">üìÑ</span>
                    <span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
                </a>
                <a href="#">
                    <span class="icon">üé®</span>
                    <span>‡∏ò‡∏µ‡∏°/‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</span>
                </a>
                <a href="#">
                    <span class="icon">üë•</span>
                    <span>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span>
                </a> -->
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main">
            <div class="header">
                <h1>‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏é (Custom Rules)</h1>
                <button class="btn btn-primary" onclick="openCreateModal()">
                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
            
            <div class="rules-table">
                <table id="rulesTable">
                    <thead>
                        <tr>
                            <th>Rule ID</th>
                            <th>Variable</th>
                            <th>Operator</th>
                            <th>Severity</th>
                            <th>Message</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API -->
                        
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° Rule -->
    <div class="modal" id="ruleModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é‡πÉ‡∏´‡∏°‡πà</h2>
            <form id="ruleForm">
                <input type="hidden" name="mode" value="create">
                <div class="form-group">
                    <label>Rule ID</label>
                    <input type="text" name="id" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 999001">
                </div>
                
                <div class="form-group">
                    <label>Variable</label>
                    <select name="variable">
                        <option value="REQUEST_URI">REQUEST_URI</option>
                        <option value="ARGS">ARGS</option>
                        <option value="REQUEST_HEADERS">REQUEST_HEADERS</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Operator (Pattern)</label>
                    <input type="text" name="operator" required placeholder="‡πÄ‡∏ä‡πà‡∏ô @rx .*admin.*">
                </div>
                
                <div class="form-group">
                    <label>Severity</label>
                    <select name="severity">
                        <option value="CRITICAL">Critical</option>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="LOW">Low</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Message</label>
                    <textarea name="message" required placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏é‡∏ô‡∏µ‡πâ"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="btn" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Rules
        async function loadRules() {
            try {
                console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                
                const res = await fetch('/api/rules/');

                console.log('Response status:', res.status);
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:', data);
                console.log('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô rules:', data.rules.length);
                
                const tbody = document.querySelector('#rulesTable tbody');
                tbody.innerHTML = '';
                
                if (!data.rules || data.rules.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Rules</td></tr>';
                    return;
                }
                
                data.rules.forEach((rule, index) => {
                    console.log(`Rule ${index}:`, rule);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${rule.id || 'N/A'}</td>
                        <td>${rule.variable || 'N/A'}</td>
                        <td>${rule.operator || 'N/A'}</td>
                        <td><span class="severity ${(rule.severity || 'medium').toLowerCase()}">${severityBadge(rule.severity || 'N/A')}</span></td>
                        <td>${rule.message || 'N/A'}</td>
                        <td class="actions">
                            <button class="btn-edit" data-rule='${JSON.stringify(rule)}'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="btn-delete" data-id="${rule.id}">‡∏•‡∏ö</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á DOM
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const ruleData = JSON.parse(this.getAttribute('data-rule'));
                        editRule(ruleData);
                    });
                });
                
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const ruleId = this.getAttribute('data-id');
                        deleteRule(ruleId);
                    });
                });
                
                console.log('‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
                
            } catch (error) {
                console.error('Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                
                const tbody = document.querySelector('#rulesTable tbody');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            }
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Rule
        document.getElementById('ruleForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            let url = '/api/rules/';
            let method = 'POST';

            if (data.mode === 'edit') {
                url = `/api/rules/${editingRuleId}`;
                method = 'PUT';
                delete data.id; // PUT ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á id
            }

            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            closeModal();
            loadRules();
        });

        
        // ‡∏•‡∏ö Rule
        async function deleteRule(id) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏é‡∏ô‡∏µ‡πâ?')) {
                await fetch(`/api/rules/${id}`, { method: 'DELETE' });
                loadRules();
            }
        }

        
        function openModal() {
            document.getElementById('ruleModal').classList.add('active');
        }


        
        function closeModal() {
            document.getElementById('ruleModal').classList.remove('active');
        }
        
        function openCreateModal() {
            const form = document.getElementById('ruleForm');
            form.reset();
            form.mode.value = 'create';
            form.id.disabled = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ID
            editingRuleId = null;

            document.querySelector('#ruleModal h2').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é‡πÉ‡∏´‡∏°‡πà';
            openModal();
        }


        function severityBadge(sev) {
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô severity ‡πÄ‡∏õ‡πá‡∏ô badge
            const map = {
                CRITICAL: "badge-danger",
                HIGH: "badge-warning",
                MEDIUM: "badge-info",
                LOW: "badge-secondary"
            };
            return `<span class="badge ${map[sev] || 'badge-light'}">${sev}</span>`;
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Rule
        
        let editingRuleId = null;

        function editRule(ruleData) {
            console.log('Edit Rule:', ruleData);
            
            editingRuleId = ruleData.id;

            const form = document.getElementById('ruleForm');

            form.mode.value = 'edit';
            form.id.value = ruleData.id;
            form.id.disabled = true;  // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ID
            form.variable.value = ruleData.variable;   
            form.operator.value = ruleData.operator;
            form.severity.value = ruleData.severity;
            form.message.value = ruleData.message;

            document.querySelector('#ruleModal h2').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏é';
            openModal(); 
        }


        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô page load
        loadRules();
    </script>
</body>
</html>